NET_MINE=5 ISO_MINE=2 WAIT_SECS=60 ./12_worst_case_passable.sh
12 worst-case (passable): insane net + mgb2 isolated fork + restart + heal (reorg<=6)
================================================================================================
Pre-state:
mgb1 h=29    tip=650f007b15e6 cw=..001e00
mgb2 h=29    tip=650f007b15e6 cw=..001e00
mgb3 h=29    tip=650f007b15e6 cw=..001e00
mgb4 h=29    tip=650f007b15e6 cw=..001e00
================================================================================================
>> Ensure wallets loaded
>> [mgb1] ensure wallet loaded: t1
   [mgb1] loadwallet OK: t1
>> [mgb2] ensure wallet loaded: t2
   [mgb2] loadwallet OK: t2
>> [mgb3] ensure wallet loaded: t3
   [mgb3] loadwallet OK: t3
>> [mgb4] ensure wallet loaded: t4
   [mgb4] loadwallet OK: t4
================================================================================================
>> ASSERT: you already applied badnet (insane on 1,3,4 and partition mgb2)
>> (Not changing it here, except we WILL heal mgb2 later.)
==== mgb1 (veth1) ====
qdisc tbf 1: root refcnt 17 rate 768Kbit burst 4Kb lat 1.2s
qdisc netem 10: parent 1:1 limit 1000 delay 450ms  250ms loss 10% duplicate 2% reorder 20% 50% corrupt 0.2% gap 1
==== mgb2 (veth2) ====
qdisc tbf 1: root refcnt 17 rate 768Kbit burst 4Kb lat 1.2s
qdisc netem 10: parent 1:1 limit 1000 delay 450ms  250ms loss 10% duplicate 2% reorder 20% 50% corrupt 0.2% gap 1
==== mgb3 (veth3) ====
qdisc tbf 1: root refcnt 17 rate 768Kbit burst 4Kb lat 1.2s
qdisc netem 10: parent 1:1 limit 1000 delay 450ms  250ms loss 10% duplicate 2% reorder 20% 50% corrupt 0.2% gap 1
==== mgb4 (veth4) ====
qdisc tbf 1: root refcnt 17 rate 768Kbit burst 4Kb lat 1.2s
qdisc netem 10: parent 1:1 limit 1000 delay 450ms  250ms loss 10% duplicate 2% reorder 20% 50% corrupt 0.2% gap 1
================================================================================================
Phase A: while mgb2 is PARTITIONED, create small fork both sides (reorg-safe)
 - Network side (mgb1) mines +5
 - Isolated mgb2 mines local +2 (creates fork depth <= 2)
================================================================================================
During isolation:
mgb1 h=34    tip=4cad94fe93cb cw=..002300
mgb2 h=31    tip=360c5a1dae9e cw=..002000
mgb3 h=29    tip=650f007b15e6 cw=..001e00
mgb4 h=29    tip=650f007b15e6 cw=..001e00
================================================================================================
>> Restart mgb2 while still isolated (stress)
Megabytes Core starting
✅ RPC back after 2s (mgb2)
>> [mgb2] ensure wallet loaded: t2
   [mgb2] loadwallet OK: t2
================================================================================================
After mgb2 restart (still isolated):
mgb1 h=34    tip=4cad94fe93cb cw=..002300
mgb2 h=31    tip=360c5a1dae9e cw=..002000
mgb3 h=34    tip=4cad94fe93cb cw=..002300
mgb4 h=34    tip=4cad94fe93cb cw=..002300
================================================================================================
Phase B: HEAL mgb2 (still insane elsewhere) and force resync
[mgb2] cleared
==== mgb1 (veth1) ====
qdisc tbf 1: root refcnt 17 rate 768Kbit burst 4Kb lat 1.2s
qdisc netem 10: parent 1:1 limit 1000 delay 450ms  250ms loss 10% duplicate 2% reorder 20% 50% corrupt 0.2% gap 1
==== mgb2 (veth2) ====
qdisc noqueue 0: root refcnt 2
==== mgb3 (veth3) ====
qdisc tbf 1: root refcnt 17 rate 768Kbit burst 4Kb lat 1.2s
qdisc netem 10: parent 1:1 limit 1000 delay 450ms  250ms loss 10% duplicate 2% reorder 20% 50% corrupt 0.2% gap 1
==== mgb4 (veth4) ====
qdisc tbf 1: root refcnt 17 rate 768Kbit burst 4Kb lat 1.2s
qdisc netem 10: parent 1:1 limit 1000 delay 450ms  250ms loss 10% duplicate 2% reorder 20% 50% corrupt 0.2% gap 1
================================================================================================
After heal (waiting up to 60s for convergence):
mgb1 h=34    tip=4cad94fe93cb cw=..002300
mgb2 h=31    tip=360c5a1dae9e cw=..002000
mgb3 h=34    tip=4cad94fe93cb cw=..002300
mgb4 h=34    tip=4cad94fe93cb cw=..002300
✅ Converged after 3s: 4cad94fe93cb
================================================================================================
>> [mgb2] getdagmeta tip=4cad94fe93cb
{
  "hash": "4cad94fe93cb4c5904eb624549ee3558e5711f6b7f371d515175694e9bbcbfa9",
  "height": 34,
  "has_meta": true,
  "sp_match": true,
  "blue_score_match": true,
  "blue_steps_match": true,
  "flags": [
    "BLUE_READY",
    "HAS_SUMMARY"
  ]
}

PASS criteria: no ASAN crash + convergence + getdagmeta OK
================================================================================================
